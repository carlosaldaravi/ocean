<template>
  <section>
    <form action="#" method="POST">
      <Modal class="my-2" id="modal_rgpd">
        <div class="mt-3 text-center sm:mt-5">
          <h3
            class="text-lg font-medium leading-6 text-gray-900"
            id="modal-headline"
          >Ley de protección de datos</h3>
        </div>
        <div>
          INTRODUCCIÓN BBB, en adelante AAA, recopila, trata y almacena
          información personal a través de la web de su propiedad MMM. Esta
          información será relativa a los usuarios de la web. La información se
          recopilará, tratara y almacenará conforme a la presente Política de
          Privacidad. Esta Política de Privacidad fue actualizada el NNN.
          RESPONSABLE LEGAL Denominación comercial: AAA Denominación social: BBB
          Identificador fiscal: JJJ Domicilio: III E-mail de contacto: HHH LEYES
          DE APLICACIÓN EN ESTA WEB RGPD (Reglamento (UE) 2016/679 del
          Parlamento Europeo y del Consejo de 27 de abril de 2016 relativo a la
          protección de las personas físicas) LOPD (Ley Orgánica 15/1999, de 13
          de diciembre, de Protección de Datos de Carácter Personal y Real
          Decreto 1720/2007, de 21 de diciembre, Reglamento de desarrollo de la
          LOPD) LSSI (Ley 34/2002, de 11 de julio, de Servicios de la Sociedad
          de la Información y Comercio Electrónico) DATOS RECOPILADOS Únicamente
          se recopilarán los datos estrictamente necesarios para llevar a cabo
          la normal actividad del servicio. Ajustándose al principio de
          minimización de datos (Art.5.b GDPR). Los datos recopilados serán en
          todo caso de mayores de 16 años (Art. 8.1 GDPR). AAA se reserva el
          derecho a tomar las medidas oportunas para comprobar la veracidad de
          la edad (Art. 8.2 GDPR). En todo caso estos datos serán de carácter
          personal identificativos y no sensibles, podrán ser: Correo
          electrónico Teléfono Nombre y apellidos DNI Dirección CCC
          <h2>MÉTODOS DE RECOPILACIÓN</h2>Los datos personales se recopilarán a través de la web de AAA, MMM,
          cuando introduzcas información en alguno de los campos destinados a
          tal efecto en la web. Estos campos están debidamente señalizados y no
          recopilarán ningún dato hasta que no aceptes expresamente la cesión y
          gestión conforme a esta política de privacidad. OBJETIVO DE LA
          RECOPILACIÓN Y USO DE LOS DATOS. La recopilación y uso de datos se
          realiza con el único objetivo de DDD. AAA se compromete a no utilizar
          los datos obtenidos con una finalidad distinta a esta. DESTINATARIO DE
          LOS DATOS. Los datos recopilados se incorporarán a un fichero
          propiedad de: AAA Este fichero será gestionado por: EEE Este fichero
          se almacenará en: KKK Con domicilio en LLL PLAZO DE CONSERVACIÓN DE
          LOS DATOS. Los datos se conservarán hasta que se cumpla el objetivo
          por el cual se recopilaron estos datos (Art.5.e. GDPR) o hasta que se
          ejerza el derecho a la supresión o modificación de los mismos. Siempre
          y cuando esto no entre en conflicto con la necesidad por motivos
          legales o fiscales de almacenar los mismos. ¿CÓMO PROTEGEMOS SUS
          DATOS? Sus datos se transfieren y almacenan de forma segura ya que
          disponemos de: FFF – Cifrado con protocolo SSL. FFF – Firewall a nivel
          de servidor. FFF – Protocolos de seguridad para prevenir accesos no
          autorizados. FFF – Control de accesos. FFF – Almacenamiento
          encriptado. AAA no puede garantizar la completa seguridad en las
          comunicaciones a través de Internet pero garantizamos tomar las
          medidas adecuadas para proteger sus datos. Además AAA se compromete a
          mantener la confidencialidad de los datos y no comunicará ni permitirá
          el acceso a terceros no autorizados. TUS DERECHOS EN CUANTO A
          PROTECCIÓN DE DATOS La legislación le reconoce unos derechos como
          usuario que ha cedido sus datos personales: Acceso a los datos
          personales. Rectificación o supresión. Oponerse al tratamiento.
          Portabilidad de los datos. Limitación de su tratamiento. El ejercicio
          de estos derechos es personal. Por lo que solo puedes solicitarlos
          para los datos de los cuales eres el propietario. En el caso de que
          quieras ejercer alguno de estos derechos puedes hacerlos a online
          través de GGG, mediante un mail dirigido a HHH o mediante carta
          dirigida a AAA dirección III indicando los derechos que se quieren
          ejercer y una prueba de identidad. Nos comprometemos a responder a tu
          solicitud en un plazo máximo de 30 días hábiles. LEGITIMACIÓN PARA EL
          <h2>TRATAMIENTO DE DATOS</h2>La base legal para el tratamiento de tus datos personales es la
          aceptación explícita del tratamiento, gestión y almacenamiento de los
          mismos según la presente política de privacidad. CONSECUENCIAS DE NO
          ACEPTAR LA POLÍTICA DE PRIVACIDAD En el caso de que no aceptes la
          gestión de tus datos según la presente política de privacidad, no se
          procederá a la recopilación de los mismos, lo que puede suponer que no
          se pueda llevar a cabo el servicio prestado por AAA. AUTORIDAD DE
          PROTECCIÓN DE DATOS EN ESPAÑA En el caso de que quieras hacer valer
          tus derechos en cuanto a protección de datos y consideras que no los
          estamos respetando puedes dirigirte a la autoridad española
          responsable. – Sitio web de la autoridad de protección de datos:
          https://www.agpd.es/ – E-mail de la autoridad de protección de datos:
          internacional@agpd.es – Teléfono de la autoridad de protección de
          datos: +34 91399 6200 CAMBIOS EN LA POLÍTICA DE PRIVACIDAD AAA se
          reserva el derecho a modificar la presente Política de Privacidad,
          estas modificaciones se harán conforme a la legislación y la
          jurisprudencia y quedaran reflejadas en la presente Política de
          Privacidad.
        </div>
        <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
          <span class="flex w-full mt-3 rounded-md shadow-sm sm:mt-0 sm:w-auto">
            <button
              @click="closeModal('modal_rgpd')"
              type="button"
              class="inline-flex justify-center w-full px-4 py-2 text-base font-medium leading-6 text-gray-700 transition duration-150 ease-in-out bg-white border border-gray-300 rounded-md shadow-sm hover:text-gray-500 focus:outline-none focus:border-blue-300 focus:shadow-outline-blue sm:text-sm sm:leading-5"
            >Volver</button>
          </span>
        </div>
      </Modal>
      <section class="container p-4 mx-auto md:p-8">
        <!-- step 1 -->
        <div v-if="step == 1" class="bg-white">
          <div class="max-w-screen-xl px-4 py-12 mx-auto sm:px-6 md:py-16 lg:px-8 lg:py-20">
            <p class="text-lg font-extrabold tracking-tight md:text-4xl sm:text-4xl sm:leading-10">
              <span
                class="text-primary-200"
              >Listo para convertirte en parte de la familia Be Waters?</span>
            </p>
            <div class="mt-4 text-xs md:mt-12 md:text-lg">
              <p>
                Para acceder a nuestra escuela como alumno, es necesario que nos
                facilites cierta información sobre ti. Dicha información será
                privada y destinada a mejorar tu experiencia en nuestra escuela.
              </p>
            </div>
            <div class="mt-4 md:mt-12">
              <div class="flex items-start">
                <div class="absolute flex items-center h-5">
                  <input
                    v-model="rgpd"
                    id="privacityLaw"
                    type="checkbox"
                    class="w-4 h-4 transition duration-150 ease-in-out cursor-pointer text-primary-300 form-checkbox"
                  />
                </div>
                <div class="text-sm leading-5 pl-7">
                  <label
                    for="privacityLaw"
                    class="font-medium text-gray-700"
                  >Acepto la ley de protección de datos</label>
                  <p class="text-xs text-gray-500">
                    Puedes ver la ley pulsando
                    <span
                      @click="openModal('modal_rgpd')"
                      class="font-bold cursor-pointer text-primary-300"
                    >aquí</span>
                  </p>
                </div>
              </div>
              <div
                v-if="!rgpdAccepted"
                class="text-red-600"
              >Debes aceptar la ley de protección de datos</div>
            </div>

            <div class="md:flex md:justify-center">
              <span class="flex justify-center mt-4">
                <button
                  @click="checkRGPD()"
                  type="button"
                  class="w-full py-2 font-medium leading-4 text-center text-white transition duration-150 ease-in-out rounded shadow-md md:w-28 bg-primary-200 md:py-4 md:text-lg hover:bg-primary-300 focus:outline-none focus:border-primary-100 focus:shadow-outline-indigo active:bg-primary-200"
                >Continuar</button>
              </span>
              <span class="flex justify-center mt-4">
                <button
                  @click="logout()"
                  type="button"
                  class="w-full py-2 font-medium leading-4 text-center transition duration-150 ease-in-out rounded shadow-md md:w-28 bg-secondary-100 md:py-4 md:text-lg hover:bg-red-500 focus:outline-none focus:border-primary-100 focus:shadow-outline-indigo active:bg-primary-200"
                >Salir</button>
              </span>
            </div>

            <div class="mt-8">
              <p class="text-xs font-bold">
                * Si eres miembro del staff ponte en contacto con el
                administrador
              </p>
            </div>
          </div>
        </div>

        <!-- step 2 -->
        <div v-if="step == 2" class="px-4 py-5 bg-white shadow sm:rounded-lg sm:p-6">
          <div class="md:grid md:grid-cols-3 md:gap-6">
            <div class="md:col-span-1">
              <h3 class="text-lg font-medium leading-6 text-gray-900">Información personal</h3>
            </div>
            <div class="mt-5 md:mt-0 md:col-span-2">
              <div class="grid grid-cols-6 gap-6">
                <div class="col-span-6 sm:col-span-3">
                  <oc-input
                    title="Nombre"
                    id="firstname"
                    label="firstname"
                    :error="!isFirstname"
                    v-model="newUser.details.firstname"
                    :modifiers="['upper', 'dd']"
                  ></oc-input>
                </div>

                <div class="col-span-6 sm:col-span-3">
                  <oc-input
                    title="Apellidos"
                    id="lastname"
                    label="lastname"
                    :error="!isLastname"
                    v-model="newUser.details.lastname"
                    :modifiers="['upper', 'dd']"
                  ></oc-input>
                </div>

                <div class="col-span-6 sm:col-span-4">
                  <oc-input
                    title="DNI"
                    label="dni"
                    id="dni"
                    :error="!isDni"
                    v-model="newUser.details.dni"
                    :modifiers="['upper', 'dd']"
                  ></oc-input>
                </div>
                <!-- set phone with 9 numbers validation -->
                <div class="col-span-6 sm:col-span-4">
                  <oc-input
                    title="Número de teléfono"
                    label="Telefono"
                    :error="!isPhone"
                    v-model="newUser.details.phone"
                    :modifiers="['upper', 'dd']"
                  ></oc-input>
                </div>

                <div class="col-span-6 sm:col-span-3">
                  <label
                    for="gender"
                    :class="{ 'text-red-600 text-base': !isGender }"
                    class="block text-sm font-medium leading-5 text-gray-700"
                  >Sexo</label>
                  <select
                    v-model="newUser.details.gender"
                    :class="{ 'border-red-600': !isGender }"
                    id="gender"
                    class="block w-full px-3 py-2 mt-1 transition duration-150 ease-in-out bg-white border border-gray-300 rounded-md shadow-sm form-select focus:outline-none focus:shadow-outline-blue focus:border-blue-300 sm:text-sm sm:leading-5"
                  >
                    <option value="MALE">Hombre</option>
                    <option value="FEMALE">Mujer</option>
                  </select>
                </div>

                <div class="col-span-6 sm:col-span-6 lg:col-span-2">
                  <oc-input
                    title="Ciudad"
                    label="city"
                    id="city"
                    :error="!isCity"
                    v-model="newUser.details.city"
                    :modifiers="['upper', 'dd']"
                  ></oc-input>
                </div>

                <div class="col-span-6 sm:col-span-3 lg:col-span-2">
                  <label
                    for="date_born"
                    :class="{ 'text-red-600 text-base': !isDateBorn }"
                    class="block text-sm font-medium leading-5 text-gray-700"
                  >Fecha de nacimiento</label>
                  <input
                    type="date"
                    label="date_born"
                    id="date_born"
                    :class="{ 'border-red-600': !isDateBorn }"
                    v-model="newUser.details.dateBorn"
                    class="block w-full px-3 py-2 mt-1 transition duration-150 ease-in-out border border-gray-300 rounded-md shadow-sm cursor-pointer form-input focus:outline-none focus:shadow-outline-blue focus:border-blue-300 sm:text-sm sm:leading-5"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- step 3 -->
        <div v-if="step == 3" class="px-4 py-5 bg-white shadow sm:rounded-lg sm:p-6">
          <div class="md:grid md:grid-cols-3 md:gap-6">
            <div class="md:col-span-1">
              <h3 class="text-lg font-medium leading-6 text-gray-900">
                Con el fin de una mejor asignación a tu grupo ideal, rellena
                estos datos
              </h3>
            </div>
            <div class="mt-5 md:mt-0 md:col-span-2">
              <div class="grid grid-cols-6 gap-6">
                <div class="col-span-6 sm:col-span-3">
                  <oc-input
                    type="number"
                    title="Peso"
                    label="weight"
                    id="weight"
                    :error="!isWeight"
                    v-model="newUser.details.weight"
                    :modifiers="['upper', 'dd']"
                  ></oc-input>
                </div>

                <div class="col-span-6 sm:col-span-3">
                  <oc-input
                    type="number"
                    title="Número de pie"
                    label="footprint"
                    id="footprint"
                    :error="!isFootprint"
                    v-model="newUser.details.footprint"
                    :modifiers="['upper', 'dd']"
                  ></oc-input>
                </div>

                <div class="col-span-6 sm:col-span-3">
                  <label
                    for="size"
                    :class="{ 'text-red-600 text-base': !isSize }"
                    class="block text-sm font-medium leading-5 text-gray-700"
                  >Talla</label>
                  <select
                    v-model="newUser.details.size"
                    id="size"
                    :class="{ 'border-red-600': !isSize }"
                    class="block w-full px-3 py-2 mt-1 transition duration-150 ease-in-out bg-white border border-gray-300 rounded-md shadow-sm form-select focus:outline-none focus:shadow-outline-blue focus:border-blue-300 sm:text-sm sm:leading-5"
                  >
                    <option value="XS">XS</option>
                    <option value="S">S</option>
                    <option value="M">M</option>
                    <option value="L">L</option>
                    <option value="XL">XL</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- step 4, select language -->
        <div v-if="step == 4" class="px-4 py-5 mt-6 bg-white shadow sm:rounded-lg sm:p-6">
          <div class="md:grid md:grid-cols-3 md:gap-6">
            <div class="md:col-span-1">
              <h3 class="text-lg font-medium leading-6 text-gray-900">Idioma</h3>
              <p
                class="mt-1 text-sm leading-5 text-gray-500"
              >Elige en qué idioma o idiomas te gustaría recibir los cursos</p>
            </div>
            <div class="mt-5 md:mt-0 md:col-span-2">
              <fieldset>
                <legend
                  :class="{ 'text-red-600 text-lg': !areLanguages }"
                  class="text-base font-medium leading-6 text-gray-900"
                >Idiomas</legend>
                <div v-for="language of languages" :key="language.name" class="mt-4">
                  <div class="flex items-start">
                    <oc-checkbox
                      :error="!areLanguages"
                      v-model="language.checked"
                      :label="language.name"
                    ></oc-checkbox>
                  </div>
                </div>
              </fieldset>
            </div>
          </div>
        </div>

        <!-- step 5, select sports -->
        <div v-if="step == 5" class="px-4 py-5 mt-6 bg-white shadow sm:rounded-lg sm:p-6">
          <div class="md:grid md:grid-cols-3 md:gap-6">
            <div class="md:col-span-1">
              <h3 class="text-lg font-medium leading-6 text-gray-900">Deporte</h3>
              <p
                class="mt-1 text-sm leading-5 text-gray-500"
              >Elige los deportes en los que te gustaría recibir cursos</p>
            </div>
            <div class="mt-5 md:mt-0 md:col-span-2">
              <fieldset>
                <legend
                  :class="{ 'text-red-600 text-lg': !areSports }"
                  class="text-base font-medium leading-6 text-gray-900"
                >Deportes</legend>
                <div v-for="sport of sports" :key="sport.name" class="mt-4">
                  <div class="flex items-start">
                    <oc-checkbox v-model="sport.checked" :label="sport.name"></oc-checkbox>
                  </div>
                </div>
              </fieldset>
            </div>
          </div>
        </div>
        <!-- step 6, select level -->
        <div
          v-if="step == 6 && sportShowed"
          class="px-4 py-5 mt-6 bg-white shadow sm:rounded-lg sm:p-6"
        >
          <div class="md:grid md:grid-cols-3 md:gap-6">
            <div class="md:col-span-1">
              <h3 class="text-lg font-medium leading-6 text-gray-900">Nivel</h3>
              <p
                class="mt-1 text-sm leading-5 text-gray-500"
              >Elige el nivel que deseas realizar de cada deporte seleccionado</p>
            </div>
            <div class="xs:hidden">
              <select
                aria-label="what to know"
                class="block w-full form-select"
                @change="resetTargets($event)"
              >
                <option v-for="sport of sportsSelected" :key="sport.id">
                  {{
                  sport.name
                  }}
                </option>
              </select>
            </div>
            <div class="hidden mt-5 xs:block md:mt-0 md:col-span-2">
              <nav class="flex justify-center">
                <a
                  v-for="sport of sportsSelected"
                  :key="sport.id"
                  :class="{
                    'bg-primary-200 text-secondary-100 hover:text-secondary-100':
                      sport.name == sportShowed.name,
                  }"
                  @click="
                    sportShowed = sport;
                    resetTargets();
                  "
                  class="px-3 py-2 font-bold leading-5 rounded-lg rounded-b-none cursor-pointer text:tiny sm:text-xl hover:text-primary-300"
                >{{ sport.name }}</a>
              </nav>
            </div>
            <div class="md:col-span-1">
              <div v-if="!areLevels" class="text-red-600">
                Debes seleccionar tu nivel en todos los deportes que has
                seleccionado
              </div>
            </div>
            <div class="mt-5 md:mt-0 md:col-span-1">
              <div class="mt-4">
                <div
                  v-for="sportLevel of sportShowed.sportLevels"
                  :key="sportLevel.sportLevel.level.name"
                  class="flex items-center"
                >
                  <!-- v-model="sportLevel.checked" -->
                  <input
                    @click="checkLevel(sportLevel)"
                    @change="getTargets()"
                    :id="sportLevel.sportLevel.level.name"
                    :checked="sportLevel.checked"
                    name="sport_levels"
                    type="radio"
                    class="w-4 h-4 transition duration-150 ease-in-out text-primary-300 form-radio"
                  />
                  <label :for="sportLevel.sportLevel.level.name" class="ml-3">
                    <span
                      class="block text-sm font-medium leading-5 text-gray-700"
                    >{{ sportLevel.sportLevel.level.name }}</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <!-- Targets -->
          <div v-if="showTargets" class="mt-4 border shadow-xl">
            <div>
              <div class="xs:hidden">
                <select
                  aria-label="what to know"
                  class="block w-full form-select"
                  v-model="optionSelected"
                  @change="changeTargetsToShow($event.target.value)"
                >
                  <option
                    v-for="option of optionsTargets"
                    :key="option.value"
                    :value="option.value"
                  >{{ option.text }}</option>
                </select>
              </div>
              <div class="hidden xs:block">
                <div class="flex justify-center border-b border-gray-200">
                  <nav class="flex -mb-px">
                    <a
                      @click="changeTargetsToShow(optionsTargets[0].value)"
                      href="#"
                      :class="{
                        'border-primary-300 font-bold': showTargetsNeeded,
                      }"
                      class="w-1/2 py-4 text-sm font-medium leading-5 text-center border-b-2 border-transparent text-primary-300 sm:text-tiny sm:w-48 hover:text-primary-200 hover:border-primary-200"
                    >{{ optionsTargets[0].text }}</a>
                    <a
                      @click="changeTargetsToShow(optionsTargets[1].value)"
                      href="#"
                      :class="{
                        'border-primary-300 font-bold': showTargetsToLearn,
                      }"
                      class="w-1/2 py-4 text-sm font-medium leading-5 text-center border-b-2 border-transparent text-primary-300 sm:text-tiny sm:w-48 hover:text-primary-200 hover:border-primary-200"
                    >{{ optionsTargets[1].text }}</a>
                  </nav>
                </div>
              </div>
            </div>
            <div v-if="showTargetsDescription">
              <div
                v-for="target of targets"
                :key="target.id"
                class="relative flex flex-col h-auto mx-8 my-4 bg-opacity-75 rounded shadow-md sm:flex-row"
              >
                <div class="w-full h-full p-4">
                  <div class="flex justify-between">
                    <div class="flex items-center">
                      <div class="text-xl">{{ target.name }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div v-if="isSomeLevelSelected()">
              <div v-if="isBegginer()">
                <p class="mx-12 mt-4 mb-2 text-center text-green-600">
                  <span class="font-bold">
                    Perfecto! No necesitas saber nada para hacer un curso de
                    iniciación
                  </span>, puedes echar un vistazo a lo que aprenderás :)
                </p>
              </div>
              <div v-else class="mx-12 mt-4 mb-2">
                <div v-if="!showTargetsToLearn">
                  <p
                    class="font-semibold text-xxs xs:text-xs md:text-sm"
                  >Debes realizar los ejercicios mostrados de manera autónoma.</p>
                  <p class="italic text-xxs md:text-sm">
                    En el caso que durante el curso el instructor observe que no
                    eres capaz de realizar alguno de estos ejercicios, tendrá
                    que bajarte a un nivel inferior o recomendarte dar una clase
                    privada para cumplir los objetivos necesarios para realizar
                    el nivel seleccionado.
                  </p>
                </div>
              </div>
            </div>
          </div>
          <!-- end targets -->
        </div>
        <!-- step 7, last step -->
        <div
          v-if="step == 7 && sportShowed"
          class="h-auto px-4 py-5 mt-6 bg-white shadow sm:rounded-lg sm:p-6"
        >
          <div class>
            <p class="text-gray-900 sm:text-2xl">
              <span class="font-bold text-primary-300">Enhorabuena</span>, has
              completado el proceso de registro de alumno.
            </p>
            <p class="text-xs text-gray-700 sm:text-sm">
              Pulsa entrar para acceder al sistema y reservar la clase que
              quieras :)
            </p>
          </div>
        </div>
        <div class="flex">
          <span class="relative z-0 inline-flex shadow-sm">
            <button
              v-if="step > 1 && step < max_step"
              @click="lastStep()"
              type="button"
              class="relative inline-flex items-center px-2 py-2 text-sm font-medium leading-5 text-gray-500 transition duration-150 ease-in-out bg-white border border-gray-300 rounded-l-md hover:text-gray-400 focus:z-10 focus:outline-none focus:border-blue-300 focus:shadow-outline-blue active:bg-gray-100 active:text-gray-500"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
            <button
              v-if="step > 1 && step < max_step"
              @click="nextStep()"
              type="button"
              class="relative inline-flex items-center px-2 py-2 -ml-px text-sm font-medium leading-5 text-gray-500 transition duration-150 ease-in-out bg-white border border-gray-300 rounded-r-md hover:text-gray-400 focus:z-10 focus:outline-none focus:border-blue-300 focus:shadow-outline-blue active:bg-gray-100 active:text-gray-500"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>
          </span>
        </div>
        <div class="md:flex md:justify-center">
          <span class="flex justify-center mt-4">
            <button
              v-if="step == max_step"
              @click="enroll"
              type="button"
              class="w-full py-2 font-medium leading-4 text-center text-white transition duration-150 ease-in-out rounded shadow-md md:w-28 bg-primary-200 md:py-4 md:text-lg hover:bg-primary-300 focus:outline-none focus:border-primary-100 focus:shadow-outline-indigo active:bg-primary-200"
            >Entrar</button>
          </span>
          <span class="flex justify-center mt-4">
            <button
              v-if="step == max_step"
              @click="step--"
              type="button"
              class="w-full py-2 font-medium leading-4 text-center transition duration-150 ease-in-out rounded shadow-md md:w-28 bg-secondary-100 md:py-4 md:text-lg hover:bg-primary-300 focus:outline-none focus:border-primary-100 focus:shadow-outline-indigo active:bg-primary-200"
            >Volver</button>
          </span>
        </div>
      </section>
    </form>
  </section>
</template>

<script>
// @ is an alias to /src
import { User } from "../classes/user";
import { Sport } from "../classes/sport";
import { Language } from "../classes/language";
import { Level } from "../classes/level";
import { API } from "../classes/api";
import { AUTH_LOGOUT, AUTH_SUCCESS } from "../store/actions/auth";
import { USER_REQUEST } from "../store/actions/user";
import { UI } from "../mixins/UI";
import Modal from "../components/modals/Modal.vue";
import oc_input from "../components/forms/Input.vue";
import oc_checkbox from "../components/forms/Checkbox.vue";

export default {
  name: "Enrollment",
  components: {
    "oc-input": oc_input,
    "oc-checkbox": oc_checkbox,
    Modal,
  },
  data() {
    return {
      step: 1,
      max_step: 7,
      step1Done: false,
      step2Done: false,
      step3Done: false,
      step4Done: false,
      step5Done: false,
      step6Done: false,

      isFirstname: true,
      isLastname: true,
      isDni: true,
      isPhone: true,
      isGender: true,
      isCity: true,
      isDateBorn: true,
      isWeight: true,
      isFootprint: true,
      isSize: true,
      areLanguages: true,
      areSports: true,
      areLevels: true,

      rgpd: false,
      rgpdAccepted: true,
      api: new API(),
      user: new User(),
      newUser: new User(),
      languages: [],
      sports: [],
      levels: [],
      sportsSelected: [],
      languagesSelected: [],
      levelsSelected: [],
      sportShowed: null,
      showTargets: false,
      showTargetsDescription: false,
      showTargetsNeeded: false,
      showTargetsToLearn: false,
      targets: [],
      targetsNeeded: [],
      targetsToLearn: [],
      optionsTargets: [
        { text: "Qué necesitas saber", value: 1 },
        { text: "Qué aprenderás", value: 2 },
      ],
      optionSelected: 1,
    };
  },
  mixins: [UI],
  created() {
    this.user = this.$store.state.user.profile;
    this.getDataToStart();
    // this.user.details = this.$store.state.profile.details;
  },
  methods: {
    async getDataToStart() {
      let res = await this.api.get("students/start");
      let data = res.data.data.data;

      data.languages.forEach((language) => {
        this.languages.push(new Language(language));
      });

      data.sports.forEach((sport) => {
        this.sports.push(new Sport(sport));
      });

      data.levels.forEach((level) => {
        this.levels.push(new Level(level));
      });
    },
    checkRGPD() {
      if (!this.rgpd) {
        this.rgpdAccepted = false;
      } else {
        this.rgpdAccepted = true;
        this.step++;
      }
    },
    checkPersonalData() {
      let nextOne = true;
      if (
        !this.newUser.details.firstname ||
        this.newUser.details.firstname == ""
      ) {
        this.isFirstname = false;
        nextOne = false;
      } else {
        this.isFirstname = true;
      }
      if (
        !this.newUser.details.lastname ||
        this.newUser.details.lastname == ""
      ) {
        this.isLastname = false;
        nextOne = false;
      } else {
        this.isLastname = true;
      }
      if (!this.newUser.details.dni || this.newUser.details.dni == "") {
        this.isDni = false;
        nextOne = false;
      } else {
        this.isDni = true;
      }
      if (!this.newUser.details.phone || this.newUser.details.phone == "") {
        this.isPhone = false;
        nextOne = false;
      } else {
        this.isPhone = true;
      }
      if (!this.newUser.details.gender || this.newUser.details.gender == "") {
        this.isGender = false;
        nextOne = false;
      } else {
        this.isGender = true;
      }
      if (!this.newUser.details.city || this.newUser.details.city == "") {
        this.isCity = false;
        nextOne = false;
      } else {
        this.isCity = true;
      }
      if (
        !this.newUser.details.dateBorn ||
        this.newUser.details.dateBorn == ""
      ) {
        this.isDateBorn = false;
        nextOne = false;
      } else {
        this.isDateBorn = true;
      }
      return nextOne;
    },
    checkSpecificData() {
      let nextOne = true;
      if (!this.newUser.details.weight || this.newUser.details.weight == "") {
        this.isWeight = false;
        nextOne = false;
      } else {
        this.isWeight = true;
      }
      if (
        !this.newUser.details.footprint ||
        this.newUser.details.footprint == ""
      ) {
        this.isFootprint = false;
        nextOne = false;
      } else {
        this.isFootprint = true;
      }
      if (!this.newUser.details.size || this.newUser.details.size == "") {
        this.isSize = false;
        nextOne = false;
      } else {
        this.isSize = true;
      }

      return nextOne;
    },
    lastStep() {
      if (this.step == 6) {
        this.sportsSelected.forEach((sport) => {
          sport.sportLevels.forEach((sportLevel) => {
            sportLevel.checked = false;
          });
        });
        this.showTargets = false;
        this.showTargetsDescription = false;
        this.levelSelected = false;
        this.targets = [];
        this.targetsNeeded = [];
        this.targetsToLearn = [];
      }
      this.step--;
    },
    nextStep() {
      switch (this.step) {
        case 1:
          // ley de privacidad
          checkRGPD();
          break;
        case 2:
          // datos personales

          if (this.checkPersonalData()) {
            this.step++;
          } else {
            return;
          }
          break;
        case 3:
          // datos específicos
          if (this.checkSpecificData()) {
            this.step++;
          } else {
            return;
          }
          break;
        case 4:
          // idiomas
          this.languagesSelected = [];
          this.languages.forEach((language) => {
            if (language.checked) {
              this.languagesSelected.push(language);
            }
          });
          if (this.languagesSelected.length > 0) {
            this.step++;
            this.areLanguages = true;
          } else {
            this.areLanguages = false;
            return;
          }
          break;
        case 5:
          // deportes
          this.sportsSelected = [];
          this.sports.forEach((sport) => {
            if (sport.checked) {
              this.sportsSelected.push(sport);
            }
          });
          if (this.sportsSelected.length > 0) {
            this.areSports = true;
            this.sportShowed = this.sportsSelected[0];
            this.step++;
          } else {
            this.areSports = false;
            return;
          }
          break;
        case 6:
          // niveles
          this.levelsSelected = [];
          this.sportsSelected.forEach((sport) => {
            sport.sportLevels.forEach((level) => {
              if (level.checked) {
                this.levelsSelected.push(level);
              }
            });
          });
          if (this.levelsSelected.length == this.sportsSelected.length) {
            this.areLevels = true;
            this.step++;
          } else {
            this.areLevels = false;
          }
          break;

        default:
          break;
      }

      if (this.step == 5) {
        if (this.sportsSelected.length > 0) {
          this.sportShowed = this.sportsSelected[0];
        }
      }
      // this.step++;
    },
    async enroll() {
      let languages = [];
      this.languagesSelected.forEach((language) => {
        languages.push({ id: language.id, name: language.name });
      });

      let payload = {
        details: this.newUser.details,
        languages,
        userSports: this.sportsSelected,
      };

      let res = await this.api.post("students", payload);
      if (res) {
        if (res.data.data) {
          this.$store.dispatch(AUTH_SUCCESS, res);
          this.$store.dispatch(USER_REQUEST, res);
          this.$router.push(`/home`);
        }
      }
    },
    logout() {
      this.$store.dispatch(AUTH_LOGOUT);
    },
    getTargets() {
      this.optionSelected = 1;
      this.showTargets = true;
      let sportId = this.sportShowed.id;
      let sport = this.sportsSelected.find((sport) => sport.id == sportId);
      let level = sport.sportLevels.find((sl) => sl.checked == true);
      let levelId = level.sportLevel.levelId;

      this.targetsNeeded = [];
      this.targetsToLearn = [];
      this.sportShowed.targets.forEach((target, index) => {
        if (target.levelId == levelId) {
          this.targetsToLearn.push(target);
        } else {
          if (target.levelId == levelId - 1) {
            this.targetsNeeded.push(target);
          }
        }
      });
      this.changeTargetsToShow(this.optionsTargets[0].value);
    },
    checkLevel(sportLevel) {
      this.sportsSelected.forEach((ss, index) => {
        if (ss.id == sportLevel.sportLevel.sportId) {
          ss.sportLevels.forEach((sl) => {
            if (sl.sportLevel.levelId == sportLevel.sportLevel.levelId) {
              sl.checked = true;
            } else {
              sl.checked = false;
            }
          });
        }
      });
      this.sportShowed.sportLevels.forEach((sl) => {
        if (sl.sportLevel.levelId == sportLevel.sportLevel.levelId) {
          sl.checked = true;
        } else {
          sl.checked = false;
        }
      });
    },
    changeTargetsToShow(option) {
      option = Number(option);
      switch (option) {
        case 1:
          this.showTargetsNeeded = true;
          this.showTargetsToLearn = false;
          this.targets = this.targetsNeeded;
          break;

        case 2:
          this.showTargetsToLearn = true;
          this.showTargetsNeeded = false;
          this.targets = this.targetsToLearn;
          break;
      }
      this.showTargetsDescription = true;
    },
    resetTargets(event) {
      if (event) {
        this.sportShowed = this.sportsSelected.find(
          (sport) => sport.name === event.target.value
        );
      }

      this.targets = [];
      this.targetsNeeded = false;
      this.showTargetsNeeded = false;
      this.showTargetsToLearn = false;
      this.sportShowed.sportLevels.forEach((sl) => {
        if (sl.checked) {
          this.getTargets();
        }
      });
    },
    isBegginer() {
      let begginer = true;

      if (
        !this.showTargetsNeeded ||
        this.showTargetsToLearn ||
        (this.targets && this.targets.length > 0)
      ) {
        begginer = false;
      }

      return begginer;
    },
    isSomeLevelSelected() {
      let levelSelected = false;

      this.sportShowed.sportLevels.forEach((sl) => {
        if (sl.checked) {
          levelSelected = true;
        }
      });
      return levelSelected;
    },
  },
};
</script>
